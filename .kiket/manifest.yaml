model_version: "1.0"
extension:
  sdk: ruby
  id: dev.kiket.ext.email
  name: Email Notifications
  version: 1.0.0
  description: Send email notifications with template support, digest mode, and preference management
  author: Kiket Team
  homepage: https://github.com/kiket-dev/kiket-ext-email
  delivery: http
  callback:
    url: ${EXTENSION_BASE_URL}
    secret: env.KIKET_WEBHOOK_SECRET
    timeout: 30000
    required: true
  activationEvents:
    - issue.created
    - issue.transitioned
    - issue.assigned
    - issue.commented
    - workflow.sla_breach
  permissions:
    - issues:read
    - users:read
    - notifications:write
  capabilities:
    - notifications
    - email
    - templates
    - digest-mode
    - preference-management
    - rate-limiting
  hooks:
    - event: issue.created
      template: issue_created_template
      timeout: 5000
      retries: 1
      description: Send email notification when issue is created
    - event: issue.transitioned
      timeout: 5000
      retries: 1
      description: Send email on issue state transitions
    - event: issue.assigned
      template: issue_assigned_template
      timeout: 5000
      retries: 1
      description: Notify users when assigned to issues
    - event: issue.commented
      timeout: 5000
      retries: 1
      description: Send email for new comments
    - event: workflow.sla_breach
      template: sla_breach_template
      timeout: 5000
      retries: 2
      description: Send urgent email alerts for SLA violations
  contributes:
    commands:
      - command: email.send
        title: Send Email
        description: Send an email notification to a user
        category: Notifications
        icon: bi-envelope
        keywords: ["email", "send", "notify"]
        handler:
          type: extension_event
          event: email.send
      - command: email.sendDigest
        title: Send Email Digest
        description: Send pending digest emails to all users
        category: Notifications
        icon: bi-inbox
        keywords: ["email", "digest", "batch"]
        handler:
          type: extension_event
          event: email.sendDigest
      - command: email.managePreferences
        title: Manage Email Preferences
        description: View and update email notification preferences
        category: Settings
        icon: bi-gear
        keywords: ["email", "preferences", "settings", "opt-out"]
        handler:
          type: extension_event
          event: email.managePreferences
      - command: email.validateTemplate
        title: Validate Email Template
        description: Test email template syntax with sample data
        category: Settings
        icon: bi-check2-square
        keywords: ["email", "template", "validate", "test"]
        handler:
          type: extension_event
          event: email.validateTemplate
  configuration:
    # SMTP Settings - org-wide credentials (shared across all projects)
    SMTP_HOST:
      type: string
      secret: true
      required: true
      scope: extension
      label: SMTP Host
      description: SMTP server hostname
    SMTP_PORT:
      type: integer
      default: "587"
      scope: extension
      description: SMTP server port
    SMTP_USERNAME:
      type: string
      secret: true
      required: true
      scope: extension
      label: SMTP Username
      description: SMTP authentication username
    SMTP_PASSWORD:
      type: string
      secret: true
      required: true
      scope: extension
      label: SMTP Password
      description: SMTP authentication password
    SMTP_AUTH:
      type: string
      default: "plain"
      scope: extension
      description: SMTP authentication method (plain, login, cram_md5)
    SMTP_TLS:
      type: boolean
      default: "true"
      scope: extension
      description: Enable STARTTLS for SMTP connection
    SMTP_DOMAIN:
      type: string
      default: "kiket.dev"
      scope: extension
      description: SMTP HELO domain
    EMAIL_FROM:
      type: string
      default: "notifications@kiket.dev"
      scope: extension
      description: Default FROM email address
    RATE_LIMIT_PER_MINUTE:
      type: integer
      default: "20"
      description: Maximum emails per minute
    ENABLE_SUPPRESSION:
      type: boolean
      default: "true"
      description: Honor user opt-out preferences
    # Rich Configuration - Email Templates
    issue_created_template:
      type: template
      editor: template
      language: liquid
      label: Issue Created Email Template
      description: Email template sent when a new issue is created
      default: |
        <h2>New Issue: {{ issue.title }}</h2>
        <p>Hi {{ user.name }},</p>
        <p>A new issue has been created in <strong>{{ project.name }}</strong>.</p>
        <table style="width:100%; border-collapse: collapse;">
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Issue</strong></td><td style="padding: 8px; border: 1px solid #ddd;">{{ issue.title }}</td></tr>
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Type</strong></td><td style="padding: 8px; border: 1px solid #ddd;">{{ issue.type }}</td></tr>
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Priority</strong></td><td style="padding: 8px; border: 1px solid #ddd;">{{ issue.priority }}</td></tr>
          <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Created by</strong></td><td style="padding: 8px; border: 1px solid #ddd;">{{ issue.created_by.name }}</td></tr>
        </table>
        <p><a href="{{ issue.url }}" style="background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">View Issue</a></p>
      variables:
        - name: issue
          type: object
          properties:
            - { name: id, type: number }
            - { name: title, type: string }
            - { name: type, type: string }
            - { name: priority, type: string }
            - { name: url, type: string }
            - { name: created_by, type: object }
        - name: user
          type: object
          properties:
            - { name: name, type: string }
            - { name: email, type: string }
        - name: project
          type: object
          properties:
            - { name: name, type: string }
      validation:
        max_length: 50000
    issue_assigned_template:
      type: template
      editor: template
      language: liquid
      label: Issue Assigned Email Template
      description: Email template sent when an issue is assigned
      default: |
        <h2>Issue Assigned: {{ issue.title }}</h2>
        <p>Hi {{ assignee.name }},</p>
        <p>You have been assigned to an issue in <strong>{{ project.name }}</strong>.</p>
        <p><strong>{{ issue.title }}</strong></p>
        <p>{{ issue.description | truncate: 200 }}</p>
        <p><a href="{{ issue.url }}">View Issue →</a></p>
      variables:
        - name: issue
          type: object
          properties:
            - { name: id, type: number }
            - { name: title, type: string }
            - { name: description, type: string }
            - { name: url, type: string }
        - name: assignee
          type: object
          properties:
            - { name: name, type: string }
            - { name: email, type: string }
        - name: project
          type: object
          properties:
            - { name: name, type: string }
    sla_breach_template:
      type: template
      editor: template
      language: liquid
      label: SLA Breach Alert Template
      description: Urgent email template for SLA violations
      default: |
        <div style="border-left: 4px solid #dc3545; padding-left: 16px;">
          <h2 style="color: #dc3545;">⚠️ SLA Breach Alert</h2>
          <p><strong>Issue:</strong> {{ issue.title }}</p>
          <p><strong>SLA Policy:</strong> {{ sla.policy_name }}</p>
          <p><strong>Target:</strong> {{ sla.target_time }}</p>
          <p><strong>Actual:</strong> {{ sla.actual_time }}</p>
          <p><strong>Exceeded by:</strong> {{ sla.exceeded_by }}</p>
          <p><a href="{{ issue.url }}" style="background-color: #dc3545; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">Take Action Now</a></p>
        </div>
      variables:
        - name: issue
          type: object
          properties:
            - { name: id, type: number }
            - { name: title, type: string }
            - { name: url, type: string }
        - name: sla
          type: object
          properties:
            - { name: policy_name, type: string }
            - { name: target_time, type: string }
            - { name: actual_time, type: string }
            - { name: exceeded_by, type: string }
      validation:
        max_length: 50000
        required_variables:
          - issue.title
          - sla.policy_name
    email_signature:
      type: html
      editor: html
      label: Email Signature
      description: HTML signature appended to all outgoing emails
      default: |
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 12px;">
          <p>Sent via Kiket · <a href="{{ unsubscribe_url }}">Manage preferences</a></p>
        </div>
  # Setup Wizard - guides users through extension configuration
  setup:
    # Step 1: SMTP Credentials
    - secrets:
        title: Connect to SMTP Server
        description: Enter your SMTP server credentials for sending emails
        required: true
        scope: extension
        help_url: https://docs.kiket.dev/extensions/email#smtp-configuration
        collect:
          - SMTP_HOST
          - SMTP_USERNAME
          - SMTP_PASSWORD

    # Step 2: Email Settings
    - configure:
        title: Configure Email Settings
        description: Set up email delivery options
        scope: extension
        fields:
          - key: SMTP_PORT
            type: number
            label: SMTP Port
            description: SMTP server port (usually 587 for TLS, 465 for SSL)
            default: 587
          - key: EMAIL_FROM
            type: text
            label: From Address
            description: Default sender email address
            placeholder: "notifications@yourdomain.com"
          - key: SMTP_TLS
            type: checkbox
            label: Enable TLS
            description: Use STARTTLS for secure connection
            default: true

    # Step 3: Test Connection
    - test:
        title: Test Email Delivery
        description: Send a test email to verify your SMTP configuration
        action: email.validateSmtp
        successMessage: Successfully connected to SMTP server! A test email was sent.
        required: false

    # Step 4: Getting Started Info
    - info:
        title: Setup Complete
        content: |
          ## You're all set!

          Your email integration is now configured. Here's what happens next:

          - **Issue notifications** will be sent via your SMTP server
          - **SLA breach alerts** will notify your team immediately
          - You can customize email templates in Extension Settings

          ### Tips

          - Customize email templates for your brand
          - Enable digest mode to reduce email volume
          - Use user preferences to honor opt-out requests
        links:
          - label: Email Templates Guide
            url: https://docs.kiket.dev/extensions/email#templates
            icon: book
          - label: SMTP Troubleshooting
            url: https://docs.kiket.dev/extensions/email#troubleshooting
            icon: question-circle

  custom_data:
    permissions:
      - module: dev.kiket.ext.email.deliveries
        operations: [read, write]
  assets:
    icon: ./public/icon.svg
  hosting: internal
